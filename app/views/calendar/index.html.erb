<div class='row'>
	<div id='id-repairers-list' class='span2'>
		<div id='wrap'>
			<div style='margin-bottom:74px'>
				<%= image_tag('MyTruckFleet/MyTruckFleet.png', :size => "128x64") %>	
			</div>
			<div id='external-events'>
				<% @trucks.each do |k, tf| %>
				<div class='dropable-truck-fleet-class'>
					<%= k.trading_name_of_business.first(20) %><%= ".." if k.trading_name_of_business.size > 20 %> <span id='id-arrow-down-truck-fleet'>&#x25BC;</span>
				<div class="truck-fleet-elements open">
					<% tf.each do |t| %>
						<%= link_to fleet_path(t) do %>
							<div class='external-event'>
								<% aws_name = "https://s3-ap-southeast-2.amazonaws.com/my-truck-fleet" %>
						  		<%= image_tag t.avatar.url, :size => '24x24' if t.avatar.present? %>
						  		<%= image_tag "#{aws_name}/#{t.vehicle_type}-MONO.png", :size => '24x24' if t.vehicle_type.present? && !t.avatar.present? %>
						  		<%= image_tag "#{aws_name}/Truck-MONO.png", :size => '24x24' if t.vehicle_type.nil? && !t.avatar.present? %> | 
						  		<%= t.send t.truck_fleet.setting.truck_identification.downcase %>
							</div>
						<% end %>
					<% end %>
					</div>
				</div>
				<% end if current_user.admin? %>
				<% @trucks.each do |t| %>
					<%= link_to fleet_path(t) do %>
				  		<div class='external-event'>
				  			<% aws_name = "https://s3-ap-southeast-2.amazonaws.com/my-truck-fleet" %>
				  			<%= image_tag t.avatar.url, :size => '24x24' if t.avatar.present? %>
				  			<%= image_tag "#{aws_name}/#{t.vehicle_type}-MONO.png", :size => '24x24' if t.vehicle_type.present? && !t.avatar.present? %>
				  			<%= image_tag "#{aws_name}/Truck-MONO.png", :size => '24x24' if t.vehicle_type.nil? && !t.avatar.present? %> | 
				  			<%= t.send t.truck_fleet.setting.truck_identification.downcase %>
				  		</div>
					<% end %>
				<% end if @trucks.present? if !current_user.admin? %>
			</div>
		</div>
	</div>
	<div class='span8'>
		<a href='#' id='id-my-team-link'>Display MyTeam <span id='id-my-team-arrow' class='closed'></span></a>
		<div id='id-my-team'>
			<%= image_tag('MyTeam/MyTeam.jpg', :size => "95x64") %>
			<%- model_class = Driver -%>
			<table class="table table-striped">
			  <thead>
			    <tr>
			      <th><%= model_class.human_attribute_name(:name) %></th>
			      <th><%= model_class.human_attribute_name(:phone_no) %></th>
			      <th><%= model_class.human_attribute_name(:license_expiry_date) %></th>
			    </tr>
			  </thead>
			  <tbody>
			    <% @drivers.each do |driver| %>
			      <tr>
			        <td><%= link_to driver.name, driver_path(driver) %></td>
			        <td><%= driver.phone_no %></td>
			        <td><%= driver.dl_expiry %></td>
			      </tr>
			    <% end %>
			  </tbody>
			</table>
		</div>
		<br>
		<%= image_tag('MyCalendar/MyCalendar.jpg', :size => "128x64", :class => '') %>
		<br><br>
		<div id='id-calendar'></div><br /><br />
		<h4 id='id-overdue-open'>Overdue vehicles</h4>
		<div id="id-overdue-items">
			<table class="table table-striped highlight-red open <%= 'hidden' if @overdue.nil? || @overdue.empty? %>">
			  <thead>
			    <tr>
			      <th>Make</th>
			      <th>Model</th>
			      <th>Next Service</th>
			    </tr>
			  </thead>
			  <tbody>
			    <% @overdue.each do |overdue| %>
			      <tr class=''>
			        <td class=''><%= link_to overdue.make, fleet_path(overdue) %></td>
			        <td class=''><%= overdue.model %></td>
			        <td class=''><%= overdue.next_service_date %></td>
			      </tr>
			    <% end if @overdue.present? %>
			  </tbody>
			  
			</table>
			<b><%= 'No items to display' if @overdue.nil? || @overdue.empty? %></b>
		</div>
		<h4 id="id-due-open">Due vehicles</h4>
		<div id="id-due-items">
			<table class="table table-striped <%= 'hidden' if @due.nil? || @due.empty? %>"">
				<thead>
				  <tr>
				  	<th></th>
				  	<th></th>
				  	<th></th>
				  </tr>
				</thead>
			  <tbody>
			    <% @due.each_with_index do |due, index| %>
			      <tr class='highlight-yellow'>
			        <td class='due'><%= link_to due.make, fleet_path(due) %></td>
			        <td class='due'><%= due.model %></td>
			        <td class='due'><%= due.next_service_date %></td>
			      </tr>
			    <% end if @due.present? %>
			  </tbody>
			</table>
			<%= puts @due.blank? %>
		<b><%= 'No items to display' if @due.nil? || @due.empty? %></b>
		</div>
	</div>
	<div id='id-trucks-list' class='span2'>
		<div id='wrap'>
			<div style='margin-bottom:46px'>
				<%= image_tag('MyRepairer/MyRepairer.jpg', :size => "128x64", :class => '') %>
			</div>
			<div id='external-events'>
				<% @repairers.each do |r| %>
					<%= link_to repairer_path(r) do %>
						<div class='external-event'>
							<%= image_tag r.avatar.url, :size => '16x16' %> | 
					  		<%= r.business_name %>
					  	</div>
					<% end %>
				<% end %>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript" charset="utf-8">
$(document).ready(function() {
  var startDate;
  var myTeamLink = $('#id-my-team-link');
  var myTeam = $('#id-my-team');
  var myTeamArrow = $('#id-my-team-arrow');
  var dueHeader = $("#id-due-open");
  var dueItems = $("#id-due-items");
  var overdueHeader = $("#id-overdue-open");
  var overdueItems = $("#id-overdue-items");
  
  myTeam.hide();
  dueItems.hide();
  dueHeader.click(function(){
  	dueItems.toggle("slow");
  });
  overdueHeader.click(function(){
  	overdueItems.toggle("slow");
  });
  
  myTeamLink.click(function(){
  	if (myTeamArrow.hasClass('open')){
  		myTeamLink.html('Display MyTeam');
  		myTeamArrow.removeClass('open');
  		myTeamArrow.html('&#x25BC;');
  	} else {
  		myTeamLink.html('Hide MyTeam');
  		myTeamArrow.addClass('open');
  		myTeamArrow.html('&#x25B2;');
  		
  	}	
  	myTeam.toggle('slow');
  });
 
  startDate = function() {
    var day, today;
    today = new Date();
    day = today.getDay();
    switch (day - 2) {
      case -1:
        return 6;
      case -2:
        return 5;
      default:
        return day - 2;
    }
  };
  
  $(".dropable-truck-fleet-class").click(function(){
  	if ($(this).find('div').hasClass('open')){
  		$(this).find('span').html("&#x25B2;");
  		$(this).find('div').toggle("slow").removeClass('open').addClass('closed'); //.toggle('slow')
  	} else {
  		$(this).find('span').html("&#x25BC;");
  		$(this).find('div').toggle("slow").removeClass('closed').addClass('open'); //.toggle('slow')
  	};
  });

  dateColor = function(past, current, upcoming){
	if (past) return 'red';
	if (current) return 'yellow';
	if (upcoming) return 'green';
  };
  
  agendaWeek = function(){
  	$("#id-calendar").fullCalendar('changeView', 'agendaWeek');
  };
  
  $('#id-calendar').fullCalendar({
    aspectRatio: 0.5,
    defaultView: 'agendaWeek',
    slotMinutes: 120,
    columnFormat: {
    	week: 'ddd d/M',
    	day: 'dddd d/M',
    },
	header: {
		left: 'prev,next today',
		center: 'title',
		right: 'month,basicWeek,basicDay'
	},
	viewDisplay: function(view){
		if (view.name === 'basicDay')
			$('#id-calendar').fullCalendar('changeView', 'agendaDay');
		else if (view.name === 'basicWeek')
			$('#id-calendar').fullCalendar('changeView', 'agendaWeek');
	},
    minTime: 8,
    maxTime: 20,
    firstDay: startDate(),
	events: [
	<% @services.each do |s| %>
		{
			id: <%= s.id %>,
			title: '<%= s.service_type %> SERVICE',
			color: function(){
				if (<%= s.start_service_date.nil? ? false : s.start_service_date < Date.today %>)
				  return 'red'
				else if (<%= s.start_service_date.nil? ? false : s.start_service_date >= Date.today && s.start_service_date <= Date.today + 3 %>) return '#8B8989'
				else return 'green'
			}(),			
			start: '<%= s.start_service_date %> <%= s.start_service_time.hour.to_s + ':00:00' if !s.start_service_time.nil? %>',
			end: '<%= s.start_service_date %> <%= s.finish_service_time.hour.to_s + ':00:00' if !s.finish_service_time.nil? %>',
			allDay: false
		},
	<% end %>
	],
	eventClick: function(event, jsEvent, view){
		cuteLittleWindow = window.open("/services/" + event.id + "/edit",
			"littleWindow", "location=no,width=640,height=400,top=250,left=300");
	},
	dayClick: function(date, allDay, jsEvent, view){
		m = date.getMonth() + 1;
		suffix = (date.getHours >= 12)? 'pm' : 'am';
		cuteLittleWindow = window.open("/services/new.html" + '?' + 
		'year='  + date.getFullYear() + '&' + 
		'month=' + m + '&' + 
		'day='   + date.getDate() + '&' + 
		'suffix=' + suffix + '&' +
		'hours=' + date.getHours(), "littleWindow", "location=no,width=640,height=400,top=250,left=300"); 
	}
  });
});
</script>